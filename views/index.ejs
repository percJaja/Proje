<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Real-Time Tracker</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1f2937">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNEnKuqOVowDszC4SdSpxAKwp5MVs/wsMZXRDxPRcPcVLEEaMoXIxdpL2sA7ilymAFA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --primary-hue: 244;
            --primary-saturation: 76%;
            --primary-lightness: 58%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            
            --background-start-rgb: 17, 24, 39; /* Dark Gray 900 */
            --background-end-rgb: 31, 41, 55;   /* Dark Gray 800 */
            --card-background-rgb: 55, 65, 81;    /* Dark Gray 700 */
            --text-rgb: 243, 244, 246;          /* Gray 100 */
            --subtle-text-rgb: 156, 163, 175;   /* Gray 400 */
            --border-rgb: 75, 85, 99;          /* Gray 600 */

            --success-rgb: 34, 197, 94;
            --error-rgb: 239, 68, 68;
            --warning-rgb: 245, 158, 11;

            --shadow-color: rgba(0, 0, 0, 0.3);
            --font-main: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-display: 'Nunito', sans-serif;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
        }
        body.light-theme {
            --background-start-rgb: 249, 250, 251; /* Gray 50 */
            --background-end-rgb: 243, 244, 246;   /* Gray 100 */
            --card-background-rgb: 255, 255, 255;  /* White */
            --text-rgb: 17, 24, 39;              /* Gray 900 */
            --subtle-text-rgb: 75, 85, 99;      /* Gray 600 */
            --border-rgb: 209, 213, 219;        /* Gray 300 */
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-main);
            background: linear-gradient(145deg, rgb(var(--background-start-rgb)), rgb(var(--background-end-rgb)));
            color: rgb(var(--text-rgb));
            line-height: 1.65;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse { 50% { box-shadow: 0 0 0 10px hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0); } }

        .app-header {
            background-color: rgba(var(--background-start-rgb), 0.8);
            backdrop-filter: blur(12px) saturate(180%);
            box-shadow: 0 4px 20px -5px var(--shadow-color);
            position: sticky; top: 0; z-index: 1000;
            padding: 0 5%; border-bottom: 1px solid rgba(var(--border-rgb), 0.3);
        }
        .navbar { display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .nav-logo { display: flex; align-items: center; text-decoration: none; font-size: 1.6rem; font-weight: 800; font-family: var(--font-display); color: rgb(var(--text-rgb)); }
        .nav-logo i { margin-right: 12px; color: var(--primary-color); text-shadow: 0 0 12px hsla(var(--primary-hue),var(--primary-saturation),var(--primary-lightness),0.7); border-radius: 50%; animation: pulse 2.5s infinite; }
        .nav-actions { display: flex; align-items: center; gap: 1rem; }
        .nav-links { display: flex; gap: 1.5rem; }
        .nav-link, .settings-btn {
            text-decoration: none; color: rgb(var(--subtle-text-rgb));
            font-weight: 500; padding: 10px 5px; border-bottom: 2px solid transparent;
            transition: all 0.3s ease; cursor: pointer; background: none; border-top: none; border-left: none; border-right: none; font-size: 1rem; font-family: var(--font-main);
        }
        .nav-link i, .settings-btn i { margin-right: 8px; }
        .nav-link:hover, .nav-link.active, .settings-btn:hover { color: rgb(var(--text-rgb)); border-bottom-color: var(--primary-color); }
        .settings-btn { border-bottom-style: dashed; }
        #mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: rgb(var(--text-rgb)); padding: 10px; }
        
        .app-main { flex: 1; padding: 2rem 5%; }
        .view { display: none; animation: fadeIn 0.7s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .view.active-view { display: block; }
        
		#toast-container { position: fixed; top: 90px; right: 20px; z-index: 5001; display: flex; flex-direction: column; gap: 10px; }
		.toast {
			background: rgba(var(--card-background-rgb), 0.9); backdrop-filter: blur(8px);
			color: rgb(var(--text-rgb)); padding: 1rem 1.5rem; border-radius: var(--border-radius-md);
			box-shadow: 0 6px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 1rem;
			border-left: 5px solid var(--primary-color);
			min-width: 300px; max-width: 400px;
			transform: translateX(120%); animation: slideInToast 0.5s forwards, slideOutToast 0.5s 4.5s forwards;
		}
		.toast.error { border-left-color: rgb(var(--error-rgb)); }
		.toast.success { border-left-color: rgb(var(--success-rgb)); }
		.toast-icon { font-size: 1.5rem; }
		.toast.error .toast-icon { color: rgb(var(--error-rgb)); }
		.toast.success .toast-icon { color: rgb(var(--success-rgb)); }
		@keyframes slideInToast { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
		@keyframes slideOutToast { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        .card {
            background: rgba(var(--card-background-rgb), 0.6); padding: 2.5rem; border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px -15px var(--shadow-color); border: 1px solid rgba(var(--border-rgb), 0.3);
            backdrop-filter: blur(8px) saturate(150%); margin-bottom: 2rem;
        }
        .hero-section h1 { font-size: clamp(2.2rem, 5.5vw, 4rem); font-family: var(--font-display); font-weight: 800; margin-bottom: 0.75rem; line-height: 1.2; background: linear-gradient(90deg, hsl(var(--primary-hue), var(--primary-saturation), 75%), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-section p { font-size: 1.15rem; color: rgb(var(--subtle-text-rgb)); max-width: 700px; margin: 0 auto 2.5rem; }
        
        #tracking-form { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1.5rem; }
        #tracking-number-input { width: 100%; min-height: 120px; resize: vertical; padding: 1.25rem; font-size: 1.05rem; line-height: 1.6; border: 1px solid rgba(var(--border-rgb), 0.4); border-radius: var(--border-radius-md); transition: all 0.3s ease; background-color: rgba(var(--background-end-rgb), 0.7); color: rgb(var(--text-rgb)); font-family: var(--font-main); }
        #tracking-number-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.25); }
        .form-action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
        .pro-tip { font-size: 0.9rem; color: rgb(var(--subtle-text-rgb)); }
        .track-button, .custom-button { padding: 0.85rem 1.75rem; font-size: 1rem; font-weight: 600; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.3); }
        .track-button:hover { background-color: hsl(var(--primary-hue), var(--primary-saturation), 50%); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 15px hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.4); }
        .custom-button.secondary { background-color: rgba(var(--border-rgb), 0.5); color: rgb(var(--text-rgb)); }
        .custom-button.secondary:hover { background-color: rgba(var(--border-rgb), 0.8); }

		#history-section h3 { margin-bottom: 1rem; font-family: var(--font-display); }
        #package-history-list { list-style: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .history-item { display: flex; align-items: center; justify-content: space-between; background: rgba(var(--background-end-rgb), 0.6); padding: 1rem 1.25rem; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
        .history-item:hover { background: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.1); border-color: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.3); transform: translateY(-2px); }
        .history-info .carrier { text-transform: uppercase; font-weight: 700; font-size: 0.8rem; color: var(--primary-color); }
        .history-info .tracking-number { font-family: monospace; color: rgb(var(--subtle-text-rgb)); }
        .history-actions button { background: none; border: none; color: rgb(var(--subtle-text-rgb)); cursor: pointer; padding: 5px; font-size: 1rem; transition: color 0.2s; }
        .history-actions button:hover { color: rgb(var(--error-rgb)); }
		
        #tracking-results-container { margin: 2rem auto; max-width: 900px; }
        .delivery-details-card { animation: fadeIn 0.5s ease-out; }
        .details-header { border-bottom: 1px solid rgba(var(--border-rgb), 0.5); padding-bottom: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem; }
        .details-icon { font-size: 2.5rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .details-icon.delivered { color: rgb(var(--success-rgb)); background-color: rgba(var(--success-rgb), 0.1); }
        .details-icon.in-transit { color: rgb(var(--warning-rgb)); background-color: rgba(var(--warning-rgb), 0.1); }
        .details-header h2 { font-size: 1.8rem; font-family: var(--font-display); font-weight: 700; margin: 0; }
        .details-header .subtitle { font-size: 1rem; color: rgb(var(--subtle-text-rgb)); font-family: monospace; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .detail-item { background-color: rgba(var(--background-start-rgb), 0.8); padding: 1rem; border-radius: var(--border-radius-md); border: 1px solid rgba(var(--border-rgb), 0.5); }
        .detail-item h4 { color: rgb(var(--subtle-text-rgb)); font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 500; }
        .detail-item p { font-size: 1.1rem; font-weight: 500; }
        .timeline-map-container { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 992px) { .timeline-map-container {grid-template-columns: 1.2fr 0.8fr;} } /* Timeline wider */
        .package-timeline { position: relative; padding-left: 30px; margin-top: 1rem; }
        .package-timeline::before { content: ''; position: absolute; left: 10px; top: 5px; bottom: 5px; width: 3px; background: linear-gradient(to bottom, var(--primary-color), rgba(var(--border-rgb),0.3)); border-radius: 3px; }
        .timeline-item { position: relative; margin-bottom: 1.5rem; }
        .timeline-item::before { content:''; position: absolute; left: -24px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background-color: var(--primary-color); border: 3px solid rgb(var(--card-background-rgb)); box-shadow: 0 0 0 3px var(--primary-color); }
        .timeline-item:first-child::before { background-color: rgb(var(--success-rgb)); box-shadow: 0 0 0 3px rgb(var(--success-rgb)); }
        .timeline-item strong { display: block; margin-bottom: 0.25rem; font-weight: 600; }
        .timeline-item span { color: rgb(var(--subtle-text-rgb)); font-size: 0.9rem; }
        #tracking-map-container, #delivery-chart-container { height: 380px; border-radius: var(--border-radius-lg); background: rgba(var(--background-start-rgb), 0.9); padding: 1rem; border: 1px solid rgba(var(--border-rgb), 0.4); }
        .tracking-map { width: 100%; height: 100%; border-radius: var(--border-radius-md); }
        #delivery-chart { max-height: 100%; }

        .widgets-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; max-width: 1200px; margin: 3rem auto 0; }
        @media (min-width: 992px) { .widgets-grid { grid-template-columns: 1.5fr 1fr; } }
        .widget h3 { font-family: var(--font-display); font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(var(--border-rgb), 0.5); padding-bottom: 0.5rem; }
        #dynamic-background-widget { min-height: 250px; background-size: cover; background-position: center; display: flex; align-items: flex-end; padding: 1.5rem; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        #dynamic-background-widget h3 { border-bottom: none; padding-bottom: 0; }

        .live-tracker-layout { display: grid; gap: 2rem; grid-template-columns: 320px 1fr 280px; }
        .status-panel, .users-panel { height: calc(80vh - 70px); max-height: 700px; } /* 70px for header */
        .users-panel ul { list-style: none; height: calc(100% - 70px); overflow-y: auto; } /* 70px for heading and padding */
        .user-list-item { display:flex; align-items:center; gap:12px; padding: 10px; border-radius: var(--border-radius-md); transition: background-color 0.2s; }
        .user-list-item:hover { background-color: rgba(var(--border-rgb), 0.2); }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(var(--border-rgb),0.4); }
        .map-container { padding:0 !important; border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: 0 5px 20px var(--shadow-color); }
        .leaflet-control-attribution, .leaflet-control-zoom { background: rgba(var(--card-background-rgb), 0.8) !important; color: rgb(var(--text-rgb)) !important; padding: 5px; border-radius: 4px; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: rgba(var(--card-background-rgb), 0.9) !important; color: rgb(var(--text-rgb)) !important; box-shadow: none; border: 1px solid rgba(var(--border-rgb), 0.5); }
        .chat-container { margin-top: 1.5rem; display: flex; flex-direction: column; height: 250px; }
        #chat-messages { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; border: 1px solid rgba(var(--border-rgb), 0.5); border-radius: var(--border-radius-md); padding: 0.75rem; background: rgba(var(--background-start-rgb),0.5); }
        .chat-message { margin-bottom: 0.75rem; display: flex; gap: 8px; }
        .chat-message img { width: 24px; height: 24px; border-radius: 50%; }
        .chat-message strong { color: var(--primary-color); font-weight: 600; }
        .chat-message span.timestamp { font-size: 0.75rem; color: rgb(var(--subtle-text-rgb)); margin-left: auto; }
        #chat-form { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.75rem; background: rgba(var(--background-end-rgb), 0.8); border: 1px solid rgba(var(--border-rgb), 0.5); color: rgb(var(--text-rgb)); border-radius: var(--border-radius-md); }
        #chat-input:focus { outline: none; border-color: var(--primary-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px) saturate(150%); z-index: 5000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal { background: rgb(var(--background-end-rgb)); padding: 2.5rem; border-radius: var(--border-radius-lg); box-shadow: 0 15px 50px var(--shadow-color); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s ease; border: 1px solid rgba(var(--border-rgb), 0.5); }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal h2 { margin-bottom: 1.5rem; text-align: center; font-family: var(--font-display); }
        .modal .form-row { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
        .modal label { margin-bottom: 0.25rem; font-weight: 500; color: rgb(var(--subtle-text-rgb)); }
        .modal input[type="text"], .modal input[type="color"], .modal select { width: 100%; padding: 0.75rem; background: rgba(var(--background-start-rgb),0.8); border: 1px solid rgba(var(--border-rgb),0.5); color: rgb(var(--text-rgb)); border-radius: var(--border-radius-md); }
        .modal input[type="color"] { height: 40px; padding: 0.25rem; }

        .app-footer { text-align: center; padding: 2.5rem 5%; background-color: rgb(var(--background-start-rgb)); margin-top: 3rem; color: rgb(var(--subtle-text-rgb)); font-size: 0.9rem; border-top: 1px solid rgba(var(--border-rgb), 0.5); }
        
        @media (max-width: 1199px) { .live-tracker-layout { grid-template-columns: 1fr; } .users-panel { order: 3; } }
        @media (max-width: 992px) { .widgets-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .app-main { padding: 1.5rem 3%; }
            .nav-links { display: none; flex-direction: column; position: absolute; top: 70px; left: 0; width: 100%; background: rgb(var(--background-start-rgb)); box-shadow: 0 8px 16px var(--shadow-color); padding: 1rem 0; gap: 0; }
            .nav-links.show { display: flex; }
            .nav-link, .settings-btn { text-align: center; padding: 1rem; border-bottom: 1px solid rgba(var(--border-rgb), 0.5); }
            .settings-btn { margin: 0 1rem; padding-bottom: 1rem; }
            #mobile-menu-btn { display: block; }
            .results-grid { grid-template-columns: 1fr; }
			.form-action-bar { flex-direction: column; gap: 1rem; align-items: stretch; }
        }
	</style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="app-container">
        <header class="app-header">
            <nav class="navbar">
                <a href="/" class="nav-logo"><i class="fas fa-globe-americas"></i><span>UltimateTracker</span></a>
                <div class="nav-actions">
                    <div class="nav-links" id="nav-links">
                        <a class="nav-link active" data-view="package-tracker-view"><i class="fas fa-box-open"></i> Package Tracker</a>
                        <a class="nav-link" data-view="live-tracker-view"><i class="fas fa-map-marked-alt"></i> Live Hub</a>
                        <button class="settings-btn" id="settings-btn"><i class="fas fa-sliders-h"></i> Settings</button>
                    </div>
                     <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                </div>
            </nav>
        </header>

        <main class="app-main">
            <!-- View 1: Package Tracker -->
            <div id="package-tracker-view" class="view active-view">
                <section class="hero-section text-center">
                    <h1>Universal Package Intel</h1>
                    <p>Automated carrier detection. Real-time server-side updates. Global tracking at your fingertips.</p>
                </section>
                <section class="card">
                     <form id="tracking-form">
                        <div class="textarea-group">
                             <textarea id="tracking-number-input" placeholder="Paste tracking numbers here, one per line...
e.g., 9400111202555842332669 (USPS)
1Z... (UPS)
123456789012 (FedEx)
Order ID: 113-1234567-1234567 (Amazon)" required></textarea>
                        </div>
                        <div class="form-action-bar">
                            <span class="pro-tip"><i class="fas fa-lightbulb"></i> Paste multiple numbers! We'll sort it out.</span>
						    <button type="submit" class="track-button" id="track-btn"><i class="fas fa-search-location"></i> Track Packages</button>
                        </div>
                    </form>
                    <div id="form-error"></div>
                </section>
                <div id="tracking-results-container"></div>
                 <section id="history-section" class="card" style="display: none;">
                    <h3><i class="fas fa-history"></i> Recently Tracked</h3>
                    <ul id="package-history-list"></ul>
                </section>
                <section class="widgets-grid">
                    <div id="dynamic-background-widget" class="widget card">
                        <h3><i class="fas fa-image"></i> Scene of the Day</h3>
                    </div>
                    <div id="weather-widget" class="widget card"></div>
                </section>
            </div>

            <!-- View 2: Live Geolocation Hub -->
            <div id="live-tracker-view" class="view">
                 <section class="hero-section text-center">
                    <h2>Live Geolocation Hub</h2>
                    <p>Share your location and interact with other users on the map in real-time.</p>
                </section>
                <div class="live-tracker-layout">
                    <aside class="status-panel card">
                        <h3><i class="fas fa-cogs"></i> Control Panel</h3>
                        <p id="connection-status">ðŸ”´ Disconnected</p>
                        <p><strong>Username:</strong> <span id="username-display">Not Set</span></p>
                        <p><strong>Latitude:</strong> <span id="lat">--</span></p>
                        <p><strong>Longitude:</strong> <span id="lng">--</span></p>
                        <div class="button-group">
                          <button id="startBtn" class="custom-button" disabled><i class="fas fa-location-arrow"></i> Share My Location</button>
                          <button id="stopBtn" class="custom-button secondary" disabled><i class="fas fa-stop-circle"></i> Stop Sharing</button>
                        </div>
                        <div class="chat-container">
                            <h3><i class="fas fa-comments"></i> Group Chat</h3>
                            <div id="chat-messages"></div>
                            <form id="chat-form">
                                <input type="text" id="chat-input" placeholder="Say hello...">
                                <button type="submit" class="custom-button" title="Send"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </aside>
                    <div id="map" class="map-container card"></div>
                    <aside class="users-panel card">
                         <h3><i class="fas fa-users"></i> Online Users <span id="user-count">(0)</span></h3>
                         <ul id="users-list"></ul>
                    </aside>
                </div>
            </div>
        </main>

        <footer class="app-footer">
            <p>Â© 2024 Ultimate Tracker Pro Edition. Merging client-server power for an unparalleled experience.</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="modal-title"><i class="fas fa-sliders-h"></i> Application Settings</h2>
             <div class="form-row">
                <label for="theme-switcher">Theme</label>
                <select id="theme-switcher" class="custom-button secondary">
                    <option value="dark">Dark Mode</option>
                    <option value="light">Light Mode</option>
                </select>
            </div>
            <div class="form-row">
                <label for="color-picker">Accent Color</label>
                <input type="color" id="color-picker">
            </div>
             <button id="close-settings" class="custom-button" style="width: 100%; margin-top: 1rem;">Save & Close</button>
        </div>
    </div>
    <div id="username-modal" class="modal-overlay">
         <div class="modal">
            <h2>Welcome to the Live Hub!</h2>
            <p style="text-align:center; margin-bottom: 1.5rem;">Please enter a username to appear on the map.</p>
            <form id="username-form">
                <div class="form-row">
                    <input type="text" id="username-input" placeholder="e.g., MapExplorer_77" required>
                </div>
                <button type="submit" class="custom-button" style="width:100%;">Join the Hub</button>
            </form>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = (() => { /* ... (App, ThemeManager as before) ... */ 
        const state = { currentView: 'package-tracker-view' };
        const elements = {
            views: document.querySelectorAll('.view'),
            navLinks: document.querySelectorAll('.nav-link'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            navLinksContainer: document.getElementById('nav-links'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings'),
        };
        const init = () => {
            elements.navLinks.forEach(link => link.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view)));
            elements.mobileMenuBtn.addEventListener('click', () => elements.navLinksContainer.classList.toggle('show'));
            elements.settingsBtn.addEventListener('click', () => elements.settingsModal.classList.add('visible'));
            elements.closeSettingsBtn.addEventListener('click', () => elements.settingsModal.classList.remove('visible'));
            document.querySelector('.nav-logo').addEventListener('click', (e) => { e.preventDefault(), switchView('package-tracker-view'); });
            ThemeManager.init(); PackageTracker.init(); LiveTracker.init();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW reg failed:', err));
        };
        const switchView = (viewId) => {
            state.currentView = viewId;
            elements.views.forEach(v => v.classList.toggle('active-view', v.id === viewId));
            elements.navLinks.forEach(l => l.classList.toggle('active', l.dataset.view === viewId));
            if (elements.navLinksContainer.classList.contains('show')) elements.mobileMenuBtn.click();
            if (viewId === 'live-tracker-view') LiveTracker.initMap();
        };
        return { init };
    })();

    const ThemeManager = (() => { /* ... (ThemeManager as before) ... */ 
        const elements = { themeSwitcher: document.getElementById('theme-switcher'), colorPicker: document.getElementById('color-picker') };
        const init = () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedColor = localStorage.getItem('primaryColor') || '#7c3aed';
            elements.themeSwitcher.value = savedTheme; elements.colorPicker.value = savedColor;
            applyTheme(savedTheme); applyColor(savedColor);
            elements.themeSwitcher.addEventListener('change', (e) => applyTheme(e.target.value));
            elements.colorPicker.addEventListener('input', (e) => applyColor(e.target.value));
        };
        const applyTheme = (theme) => { document.body.classList.toggle('light-theme', theme === 'light'); localStorage.setItem('theme', theme); };
        const hexToHsl = (H) => { /* ... */ return [h,s,l]; }; // Full hexToHsl code omitted for brevity, use previous version
        const applyColor = (hex) => {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) { r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16); }
            else if (hex.length == 7) { r = parseInt(hex[1] + hex[2], 16); g = parseInt(hex[3] + hex[4], 16); b = parseInt(hex[5] + hex[6], 16); }
            r /= 255; g /= 255; b /= 255; let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
            if (delta == 0) h = 0; else if (cmax == r) h = ((g - b) / delta) % 6; else if (cmax == g) h = (b - r) / delta + 2; else h = (r - g) / delta + 4;
            h = Math.round(h * 60); if (h < 0) h += 360; l = (cmax + cmin) / 2; s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
            document.documentElement.style.setProperty('--primary-hue', h);
            document.documentElement.style.setProperty('--primary-saturation', `${s}%`);
            document.documentElement.style.setProperty('--primary-lightness', `${l}%`);
            localStorage.setItem('primaryColor', hex);
        };
        return { init };
    })();

    const ToastNotifier = (() => { /* ... (ToastNotifier as before) ... */ 
        const container = document.getElementById('toast-container');
        const show = (message, type = 'info') => {
            const toast = document.createElement('div'); toast.className = `toast ${type}`;
            let iconClass = 'fa-info-circle'; if (type === 'success') iconClass = 'fa-check-circle'; if (type === 'error') iconClass = 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${iconClass} toast-icon"></i><div>${message}</div>`;
            container.appendChild(toast); setTimeout(() => toast.remove(), 5000);
        };
        return { show };
    })();

    const PackageTracker = (() => { /* ... (PackageTracker with history as before, but renderTrackingMap/Chart calls) ... */ 
        let history = [];
        const elements = { form: document.getElementById('tracking-form'), input: document.getElementById('tracking-number-input'), error: document.getElementById('form-error'), results: document.getElementById('tracking-results-container'), historySection: document.getElementById('history-section'), historyList: document.getElementById('package-history-list'), trackBtn: document.getElementById('track-btn')};
        const init = () => { elements.form.addEventListener('submit', handleFormSubmit); loadHistory(); renderWidgets(); };
        const loadHistory = () => { history = JSON.parse(localStorage.getItem('packageHistoryV2') || '[]'); renderHistory(); };
        const saveHistory = () => { localStorage.setItem('packageHistoryV2', JSON.stringify(history)); };
        const addToHistory = (data) => { if (!history.find(item => item.trackingNumber === data.trackingNumber && item.carrier === data.carrier)) { history.unshift({ trackingNumber: data.trackingNumber, carrier: data.carrier, id: Date.now(), lastStatus: data.status }); if (history.length > 7) history.pop(); saveHistory(); renderHistory(); }};
        const removeFromHistory = (id) => { history = history.filter(item => item.id !== id); saveHistory(); renderHistory(); };
        const renderHistory = () => {
            if(history.length === 0) { elements.historySection.style.display = 'none'; return; }
            elements.historySection.style.display = 'block';
            elements.historyList.innerHTML = history.map(item => `
                <li class="history-item">
                    <div class="history-info" data-tn="${item.trackingNumber}" data-carrier="${item.carrier}">
                        <div class="carrier">${item.carrier.toUpperCase()}</div> <div class="tracking-number">${item.trackingNumber}</div> <div class="tracking-number" style="font-size:0.8em; color: rgb(var(--subtle-text-rgb))">${item.lastStatus.substring(0,30)}...</div>
                    </div>
                    <div class="history-actions"><button class="delete-history-btn" data-id="${item.id}" title="Remove"><i class="fas fa-times"></i></button></div>
                </li>`).join('');
            elements.historyList.querySelectorAll('.history-info').forEach(el => el.addEventListener('click', (e) => { elements.input.value = e.currentTarget.dataset.tn; elements.form.requestSubmit(); ToastNotifier.show(`Retracking ${e.currentTarget.dataset.tn}`); }));
            elements.historyList.querySelectorAll('.delete-history-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); removeFromHistory(parseInt(e.currentTarget.dataset.id)); }));
        };
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const trackingNumbersText = elements.input.value;
            const trackingNumbers = trackingNumbersText.split('\n').map(s => s.trim()).filter(Boolean);
            elements.error.textContent = '';
            if (trackingNumbers.length === 0) { elements.error.textContent = 'Please enter at least one tracking number.'; return; }
            elements.trackBtn.disabled = true; elements.trackBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Tracking...`;
            elements.results.innerHTML = '';
            for (const tn of trackingNumbers) { await trackSinglePackage(tn); }
            elements.trackBtn.disabled = false; elements.trackBtn.innerHTML = `<i class="fas fa-search-location"></i> Track Packages`;
        };
        const trackSinglePackage = async (trackingNumber) => {
            const resultCard = document.createElement('div'); resultCard.innerHTML = `<div class="card loading-indicator"><i class="fas fa-spinner fa-spin"></i> Searching for ${trackingNumber}...</div>`;
            elements.results.insertBefore(resultCard, elements.results.firstChild); // Add new results to top
            try {
                const response = await fetch('/api/track', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trackingNumber }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Server error');
                renderResult(resultCard, data); addToHistory(data);
            } catch (error) { console.error("Tracking error:", error); resultCard.innerHTML = `<div class="card" style="border-left: 5px solid rgb(var(--error-rgb))"><i class="fas fa-exclamation-triangle"></i> Error for ${trackingNumber}: ${error.message}</div>`; }
        };
        const renderResult = (container, data) => { /* ... (renderResult including map and chart calls) ... */
            const statusIcon = data.status.toLowerCase().includes('delivered') ? 'fa-check-circle' : 'fa-truck-fast';
            const iconClass = data.status.toLowerCase().includes('delivered') ? 'delivered' : 'in-transit';
            const activityHtml = data.activity.map((act, index) => `
                <div class="timeline-item ${index === 0 ? 'active-event' : ''}">
                    <strong>${act.status}</strong>
                    <span>${act.location ? act.location +": " : ""}${act.description}</span>
                    <span style="display:block; font-size: 0.8rem;">${act.timestamp ? new Date(act.timestamp).toLocaleString() : 'N/A'}</span>
                </div>`).join('');
            container.innerHTML = `
                <div class="delivery-details-card card">
                    <div class="details-header">
                        <div class="details-icon ${iconClass}"><i class="fas ${statusIcon}"></i></div>
                        <div><h2>${data.carrier}</h2><span class="subtitle">${data.trackingNumber}</span></div>
                    </div>
                    <div class="results-grid">
                        <div class="detail-item"><h4>Status</h4><p>${data.status}</p></div>
                        <div class="detail-item"><h4>Est. Delivery</h4><p>${data.estimatedDelivery || 'Not Available'}</p></div>
                    </div>
                    <div class="timeline-map-container">
                        ${activityHtml ? `<div><h3><i class="fas fa-route"></i> Journey</h3><div class="package-timeline">${activityHtml}</div></div>` : '<p>No activity details found.</p>'}
                        <div>
                         <h3><i class="fas fa-map-signs"></i> Route Map</h3>
                         <div id="tracking-map-${data.trackingNumber.replace(/[^a-zA-Z0-9]/g, '')}" class="tracking-map"></div>
                         <h3><i class="fas fa-chart-line"></i> Delivery Analytics</h3>
                         <div id="delivery-chart-container-${data.trackingNumber.replace(/[^a-zA-Z0-9]/g, '')}"><canvas id="delivery-chart-${data.trackingNumber.replace(/[^a-zA-Z0-9]/g, '')}"></canvas></div>
                        </div>
                    </div>
                </div>`;
            renderTrackingMap(`tracking-map-${data.trackingNumber.replace(/[^a-zA-Z0-9]/g, '')}`, data.activity);
            renderTrackingChart(`delivery-chart-${data.trackingNumber.replace(/[^a-zA-Z0-9]/g, '')}`, data.activity);
        };
        const renderTrackingMap = (elementId, activity) => { /* ... (renderTrackingMap as before) ... */ 
            try {
                const mapElement = document.getElementById(elementId); if (!mapElement) return;
                const points = activity.filter(a => a.geo && a.geo.lat && a.geo.lon).map(a => [a.geo.lat, a.geo.lon]);
                if (points.length === 0) { mapElement.innerHTML = '<p style="text-align:center; padding-top: 40%; color: rgb(var(--subtle-text-rgb));">No geodata for map visualization.</p>'; return; }
                const map = L.map(elementId).setView(points[0], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.polyline(points, {color: 'var(--primary-color)', weight: 3}).addTo(map);
                points.forEach((p, i) => L.circleMarker(p, {radius: 6, fillColor: 'var(--primary-color)', color: 'rgb(var(--card-background-rgb))', weight:2, fillOpacity: 1}).addTo(map).bindPopup(activity.filter(a=>a.geo)[i].status));
                map.fitBounds(points, { padding: [50, 50] });
            } catch (e) { console.error("Map rendering failed:", e); document.getElementById(elementId).innerHTML = '<p style="text-align:center; color: rgb(var(--error-rgb));">Map could not be loaded.</p>';}
        };
        const renderTrackingChart = (canvasId, activity) => { /* ... (renderTrackingChart as before) ... */
            const chartElement = document.getElementById(canvasId); if (!chartElement || activity.length < 2) { if(chartElement) chartElement.parentElement.innerHTML = '<p style="text-align:center; padding-top: 20%; color: rgb(var(--subtle-text-rgb));">Not enough data for analytics.</p>'; return; }
            const labels = []; const data = [];
            for (let i = activity.length - 2; i >= 0; i--) { // Iterate from oldest to newest relevant event pair
                const prev = new Date(activity[i+1].timestamp); const curr = new Date(activity[i].timestamp);
                if (isNaN(prev.getTime()) || isNaN(curr.getTime())) continue; // Skip invalid dates
                const diffHours = Math.abs(curr - prev) / 36e5;
                if(diffHours > 0.1) { labels.push(`${activity[i+1].status.substring(0,15)}...`); data.push(parseFloat(diffHours.toFixed(1))); }
            }
            if (labels.length === 0) { chartElement.parentElement.innerHTML = '<p style="text-align:center; padding-top: 20%; color: rgb(var(--subtle-text-rgb));">Not enough distinct events for analytics.</p>'; return; }
            new Chart(chartElement, { type: 'bar', data: { labels, datasets: [{ label: 'Hours Between Events', data, backgroundColor: `hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.6)`, borderColor: `var(--primary-color)`, borderWidth: 1 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: {color: `rgb(var(--subtle-text-rgb))`}, grid: {color: `rgba(var(--border-rgb),0.2)`} }, x: { ticks: {color: `rgb(var(--subtle-text-rgb))`}, grid: {color: `rgba(var(--border-rgb),0.1)`} } }, plugins: { legend: { display: false } } } });
        };
        const renderWidgets = async () => {
            try {
                const unsplashRes = await fetch('https://source.unsplash.com/1600x900/?nature,travel,city');
                document.getElementById('dynamic-background-widget').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), url(${unsplashRes.url})`;
            } catch (e) {console.error("Unsplash fetch failed", e); }
            try {
                let city = 'New York'; // Default
                try { const { latitude, longitude } = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, {timeout:3000})); city = `${latitude},${longitude}`; } catch(geoErr) { console.warn("Geo disabled for weather, using default."); }
                const weatherRes = await fetch(`https://api.weatherapi.com/v1/current.json?key=f88accb345404bac91a63634253005&q=${city}`); // Replace with YOUR WeatherAPI key
                const { location, current } = await weatherRes.json();
                document.getElementById('weather-widget').innerHTML = `<h3><i class="fas fa-cloud-sun"></i> Weather in ${location.name}</h3> <div class="weather-main"><img src="${current.condition.icon}" alt="${current.condition.text}"><div class="temp">${Math.round(current.temp_c)}Â°C</div><div class="condition">${current.condition.text}</div></div> <div class="weather-details"><div class="weather-detail-item"><div class="label">Feels Like</div><div class="value">${Math.round(current.feelslike_c)}Â°C</div></div><div class="weather-detail-item"><div class="label">Humidity</div><div class="value">${current.humidity}%</div></div></div>`;
            } catch (e) { document.getElementById('weather-widget').innerHTML = '<h3><i class="fas fa-cloud-sun"></i> Weather</h3><p>Could not load weather data.</p>'; }
        };
        return { init };
    })();

    const LiveTracker = (() => { /* ... (LiveTracker with chat as before) ... */
        let map = null, markers = {}, watchId = null, username = '', socket;
        const elements = { usernameModal: document.getElementById('username-modal'), usernameForm: document.getElementById('username-form'), usernameInput: document.getElementById('username-input'), startBtn: document.getElementById('startBtn'), stopBtn: document.getElementById('stopBtn'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), chatMessages: document.getElementById('chat-messages') };
        const init = () => {
            elements.usernameForm.addEventListener('submit', handleUsernameSubmit);
            document.querySelector('a[data-view="live-tracker-view"]').addEventListener('click', () => { if(!username) elements.usernameModal.classList.add('visible'); initMap(); });
            elements.startBtn.addEventListener('click', startTracking); elements.stopBtn.addEventListener('click', stopTracking);
            elements.chatForm.addEventListener('submit', (e)=>{ e.preventDefault(); if(elements.chatInput.value && socket) { socket.emit('send_chat_message', elements.chatInput.value); elements.chatInput.value = ''; }});
        };
        const handleUsernameSubmit = (e) => { e.preventDefault(); username = elements.usernameInput.value.trim() || `User${Math.floor(Math.random()*10000)}`; document.getElementById('username-display').textContent = username; elements.usernameModal.classList.remove('visible'); elements.startBtn.disabled = false; connectSocket(); };
        const initMap = () => { if (!map && document.getElementById('map')) { map = L.map('map').setView([20, 0], 2.5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }};
        const connectSocket = () => {
             socket = io({ transports: ["websocket"] });
             socket.on('connect', () => { document.getElementById('connection-status').innerHTML = "ðŸŸ¢ Connected"; document.getElementById('connection-status').className = 'connected'; socket.emit('join', username); });
             socket.on('connect_error', () => { document.getElementById('connection-status').innerHTML = "ðŸ”´ Server Down"; });
             socket.on('current_users', (users) => users.forEach(user => updateUser(user)));
             socket.on('user_joined', (user) => { ToastNotifier.show(`${user.username} joined the map!`, 'success'); updateUser(user); });
             socket.on('receive-location', (data) => updateUser(data));
             socket.on('user_disconnected', (id) => { const u=document.getElementById(`user-${id}`); if(u) ToastNotifier.show(`${u.dataset.username} left the hub.`); removeUser(id); });
             socket.on('receive_chat_message', (data) => {
                 const msgEl = document.createElement('div'); msgEl.className = 'chat-message';
                 msgEl.innerHTML = `<img src="${data.user.avatar || 'https://i.pravatar.cc/24'}" class="user-avatar" alt="${data.user.username}"> <div><strong>${data.user.username}:</strong> ${data.message}</div> <span class="timestamp">${new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
                 elements.chatMessages.appendChild(msgEl); elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
             });
        };
        const startTracking = () => {
            if (!navigator.geolocation) { ToastNotifier.show("Geolocation is not supported by your browser.", "error"); return; }
            watchId = navigator.geolocation.watchPosition(
                ({ coords: { latitude, longitude } }) => {
                    socket.emit("send-location", { latitude, longitude });
                    updateUser({ id: socket.id, username, latitude, longitude, avatar: `https://i.pravatar.cc/40?u=${socket.id}` });
                    document.getElementById('lat').textContent = latitude.toFixed(4); document.getElementById('lng').textContent = longitude.toFixed(4);
                }, (err) => { console.error(err); ToastNotifier.show("Error getting location: " + err.message, "error");}, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 });
            elements.startBtn.disabled = true; elements.stopBtn.disabled = false; ToastNotifier.show("Location sharing started!", "success");
        };
        const stopTracking = () => { if (watchId) navigator.geolocation.clearWatch(watchId); watchId = null; elements.startBtn.disabled = false; elements.stopBtn.disabled = true; ToastNotifier.show("Location sharing stopped."); };
        const updateUser = (user) => {
            if (!map || typeof user.latitude !== 'number' || typeof user.longitude !== 'number') return;
            if (!markers[user.id]) {
                const iconHtml = `<div style="background-image: url('${user.avatar}'); width: 32px; height: 32px; border-radius: 50%; background-size: cover; border: 2px solid var(--primary-color); box-shadow: 0 0 5px var(--primary-color);"></div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'custom-leaflet-avatar-icon', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
                markers[user.id] = L.marker([user.latitude, user.longitude], {icon: customIcon}).addTo(map).bindPopup(`<b>${user.username}</b>`);
            }
            markers[user.id].setLatLng([user.latitude, user.longitude]);
            if (user.id === socket.id && map.getZoom() < 10) map.setView([user.latitude, user.longitude], 13);
            let userEl = document.getElementById(`user-${user.id}`);
            if (!userEl) { userEl = document.createElement('li'); userEl.id = `user-${user.id}`; userEl.className = 'user-list-item'; document.getElementById('users-list').appendChild(userEl); }
            userEl.dataset.username = user.username;
            userEl.innerHTML = `<img src="${user.avatar}" class="user-avatar" alt="${user.username}"> ${user.username}`;
            document.getElementById('user-count').textContent = `(${Object.keys(markers).length})`;
        };
        const removeUser = (id) => { if (markers[id]) { map.removeLayer(markers[id]); delete markers[id]; } const userEl = document.getElementById(`user-${id}`); if(userEl) userEl.remove(); document.getElementById('user-count').textContent = `(${Object.keys(markers).length})`; };
        return { init, initMap };
    })();

    // --- Grand Initialization ---
    App.init();
});
</script>
</body>
</html>
